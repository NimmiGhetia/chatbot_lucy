'use strict';

Object.defineProperty(exports, "__esModule", {
  value: true
});

var _debugLevels = require('debug-levels');

var _debugLevels2 = _interopRequireDefault(_debugLevels);

var _ssMessage = require('ss-message');

var _ssMessage2 = _interopRequireDefault(_ssMessage);

var _common = require('./common');

var _common2 = _interopRequireDefault(_common);

var _getReply = require('../getReply');

var _getReply2 = _interopRequireDefault(_getReply);

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

const debug = (0, _debugLevels2.default)('SS:Reply:inline');

const inlineRedirect = function inlineRedirect(triggerTarget, options, callback) {
  debug.verbose(`Inline redirection to: '${ triggerTarget }'`);

  // if we have a special topic, reset it to the previous one
  // in order to preserve the context for inline redirection
  if (options.topic === '__pre__' || options.topic === '__post__') {
    if (options.user.history.topic.length) {
      options.topic = options.user.history.topic[0];
    }
  }

  _common2.default.getTopic(options.system.chatSystem, options.topic, (err, topicData) => {
    const messageOptions = {
      factSystem: options.system.factSystem
    };

    _ssMessage2.default.createMessage(triggerTarget, messageOptions, (err, redirectMessage) => {
      options.pendingTopics = [topicData];

      (0, _getReply2.default)(redirectMessage, options, (err, redirectReply) => {
        if (err) {
          console.error(err);
        }

        debug.verbose('Response from inlineRedirect: ', redirectReply);
        if (redirectReply) {
          return callback(null, redirectReply);
        }
        return callback(null, {});
      });
    });
  });
};

exports.default = inlineRedirect;